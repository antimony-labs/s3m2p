name: Preview Cleanup

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Manual trigger
  issues:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    # Only run on issues with project labels
    if: |
      github.event_name != 'issues' ||
      contains(github.event.issue.labels.*.name, 'project:helios') ||
      contains(github.event.issue.labels.*.name, 'project:too.foo') ||
      contains(github.event.issue.labels.*.name, 'project:core')
    steps:
      - name: Cleanup preview for closed issue
        if: github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          ISSUE_NUM=${{ github.event.issue.number }}

          # Get project from labels
          PROJECT=$(gh issue view $ISSUE_NUM \
            --json labels \
            --jq '.labels[] | select(.name | startswith("project:")) | .name | sub("project:"; "")')

          echo "Issue #$ISSUE_NUM closed. Will cleanup preview for project: $PROJECT"
          echo "Preview will be deleted after 24 hours: issue-${ISSUE_NUM}-${PROJECT}.too.foo"

          # Post notification
          gh issue comment $ISSUE_NUM --body "ðŸ§¹ **Preview Cleanup Scheduled**

Preview deployment will be removed in 24 hours:
\`issue-${ISSUE_NUM}-${PROJECT}.too.foo\`

If you need it longer, reopen the issue within 24h.

---
*Automated cleanup*"

      - name: Cleanup old closed previews (batch)
        if: github.event_name != 'issues'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking for previews to cleanup..."

          # Get all closed issues from last 30 days
          gh issue list --state closed --limit 100 --json number,closedAt,labels | \
            jq -r '.[] | select(.closedAt != null) | @json' | \
            while IFS= read -r issue_json; do
              ISSUE_NUM=$(echo "$issue_json" | jq -r '.number')
              CLOSED_AT=$(echo "$issue_json" | jq -r '.closedAt')

              # Calculate age in hours
              CLOSED_TIMESTAMP=$(date -d "$CLOSED_AT" +%s 2>/dev/null || echo "0")
              NOW=$(date +%s)
              AGE_HOURS=$(( (NOW - CLOSED_TIMESTAMP) / 3600 ))

              # Cleanup if closed > 24 hours ago
              if [ $AGE_HOURS -gt 24 ]; then
                PROJECT=$(echo "$issue_json" | jq -r '.labels[] | select(.name | startswith("project:")) | .name | sub("project:"; "")')

                if [ -n "$PROJECT" ]; then
                  echo "Cleanup candidate: issue-${ISSUE_NUM}-${PROJECT}.too.foo (closed ${AGE_HOURS}h ago)"

                  # TODO: Call Cloudflare API to delete deployment
                  # curl -X DELETE "https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/pages/projects/s3m2p-previews/deployments/issue-${ISSUE_NUM}-${PROJECT}"
                fi
              fi
            done

          echo "Cleanup check complete"
