#!/bin/bash
# S3M2P Master Developer Tool
# Usage: ./dev [command]

set -e

SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
source "$SCRIPT_DIR/config.sh"

# ------------------------------------------------------------------
# Commands
# ------------------------------------------------------------------

cmd_docs() {
    echo "ğŸ“œ Generating Architecture Documentation..."
    node "$SCRIPT_DIR/scan_docs.js"
}

cmd_up() {
    local target="${1:-all}"

    mkdir -p "$LOG_DIR"

    if [[ "$target" == "all" ]]; then
        cmd_docs
        echo "ğŸš€ Starting ALL services..."
        echo "Logs: $LOG_DIR"
        echo ""

        local pids=()

        # Define project groups
        local -a MAIN_PROJECTS=(welcome blog)
        local -a ML_PROJECTS=(learn)
        local -a LEARN_PROJECTS=(ubuntu esp32 slam ai opencv arduino swarm)
        local -a TOOLS_PROJECTS=(pll autocrate sensors power crm)
        local -a SIM_PROJECTS=(helios chladni emergence coming_soon)

        # Function to start a project
        start_project() {
            local project="$1"
            local port="${PROJECT_PORTS[$project]}"
            local dir="${PROJECT_DIRS[$project]}"
            local path="$REPO_ROOT/$dir"
            local log="$LOG_DIR/$project.log"
            local url="http://127.0.0.1:$port"

            # Kill existing
            lsof -t -i :"$port" | xargs -r kill 2>/dev/null || true

            # Create clickable hyperlink using OSC 8 escape sequence
            local link=$'\e]8;;'"${url}"$'\e\\'"${url}"$'\e]8;;\e\\'

            if [[ -f "$path/Trunk.toml" ]] || [[ -f "$path/index.html" ]]; then
                (cd "$path" && NO_COLOR=true trunk serve index.html --port "$port" --address 0.0.0.0 > "$log" 2>&1) &
                pids+=($!)
                printf "  %-13s %s %s\n" "$project" "$link" "âœ…"
            else
                printf "  %-13s %s %s\n" "$project" "$link" "âš ï¸"
            fi
        }

        # Start each group with header
        echo "â”Œâ”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        for project in "${MAIN_PROJECTS[@]}"; do start_project "$project"; done

        echo "â”œâ”€ ML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        for project in "${ML_PROJECTS[@]}"; do start_project "$project"; done

        echo "â”œâ”€ LEARN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        for project in "${LEARN_PROJECTS[@]}"; do start_project "$project"; done

        echo "â”œâ”€ TOOLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        for project in "${TOOLS_PROJECTS[@]}"; do start_project "$project"; done

        echo "â”œâ”€ SIMULATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        for project in "${SIM_PROJECTS[@]}"; do start_project "$project"; done

        echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo ""
        echo "Press Ctrl+C to stop all."
        wait
    else
        # Single project
        local port="${PROJECT_PORTS[$target]}"
        local dir="${PROJECT_DIRS[$target]}"
        
        if [[ -z "$port" ]]; then
            echo "âŒ Unknown project: $target"
            exit 1
        fi
        
        echo "ğŸš€ Starting $target on port $port..."
        echo "Dir: $REPO_ROOT/$dir"
        cd "$REPO_ROOT/$dir"
        # trunk reads NO_COLOR as a boolean env var; some environments set NO_COLOR=1 which breaks parsing.
        NO_COLOR=true trunk serve index.html --port "$port" --address 0.0.0.0 --open
    fi
}

cmd_test() {
    echo "ğŸ§ª Running Tests..."
    
    echo ">> Unit Tests (Workspace)..."
    cargo test --workspace --exclude hw
    
    echo ">> Playwright..."
    npx playwright test
}

cmd_deploy() {
    echo "ğŸš€ Deploying..."
    "$SCRIPT_DIR/deploy.sh" "$@"
}

cmd_menu() {
    echo ""
    echo "ğŸ”® S3M2P Developer Studio"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "1) ğŸš€ Start ALL Servers"
    echo "2) â˜€ï¸  Start Helios Only"
    echo "3) ğŸ‘‹ Start Welcome Only"
    echo "4) ğŸ§ª Run Tests"
    echo "5) ğŸš¢ Deploy"
    echo "0) Exit"
    echo ""
    read -p "Select option: " opt
    
    case $opt in
        1) cmd_up all ;;
        2) cmd_up helios ;;
        3) cmd_up welcome ;;
        4) cmd_test ;;
        5) cmd_deploy all --publish ;;
        0) exit 0 ;;
        *) echo "Invalid option"; menu ;;
    esac
}

# ------------------------------------------------------------------
# Main Dispatch
# ------------------------------------------------------------------

case "${1:-}" in
    up)
        cmd_up "${2:-all}"
        ;;
    test)
        cmd_test
        ;;
    deploy)
        shift
        cmd_deploy "$@"
        ;;
    check)
        cargo check --workspace
        ;;
    help|--help|-h)
        echo "Usage: ./dev [command]"
        echo ""
        echo "Commands:"
        echo "  up [app]    Start dev servers (default: all)"
        echo "  test        Run unit & integration tests"
        echo "  deploy      Deploy to Cloudflare"
        echo "  check       Run cargo check"
        echo ""
        ;;
    *)
        cmd_menu
        ;;
esac
