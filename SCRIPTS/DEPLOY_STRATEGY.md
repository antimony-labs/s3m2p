# Deployment Strategy: Two-Tier Local Preview + CI Production

## Overview

Use `wrangler pages deploy` locally for instant preview URLs. Gate production deploys behind GitHub CI checks (fmt, clippy, test, build). This gives fast iteration without risking broken production deploys.

## Tiers

### Tier 1 — Local Preview (instant)

```bash
./SCRIPTS/dev deploy-preview <project>
```

What it does:
1. `trunk build <project>/index.html --release`
2. `wrangler pages deploy dist/ --project-name=<cf-project> --branch=preview`
3. Prints the preview URL

Preview URLs generated by Cloudflare:
- `https://<hash>.<cf-project>.pages.dev` — unique per deploy, immutable snapshot
- `https://preview.<cf-project>.pages.dev` — always points to latest preview

Production domain (e.g., `helios.too.foo`) is **never touched** by preview deploys.

### Tier 2 — Production via CI only

Production deploys happen in GitHub Actions after all checks pass:

```
git push origin main
  → CI: cargo fmt --check
  → CI: cargo clippy --workspace
  → CI: cargo test --workspace
  → CI: trunk build
  → CI: wrangler pages deploy --branch=main --production
  → Production domain updated
```

## Flow

```
Local (laptop)                          GitHub CI
──────────────                          ─────────

1. Edit code
2. Test locally (dev dashboard :9000)
3. deploy-preview helios
   → Preview URL in seconds
   → Test on phone/tablet/share URL

4. git push origin main ───────────────→ 5. CI runs checks
                                           → fmt, clippy, test
                                           → trunk build
                                           → wrangler deploy --production
                                           → helios.too.foo updated
```

## Implementation TODO

### 1. Add `deploy-preview` command to `SCRIPTS/dev`

Add a case to the dispatch block:

```bash
deploy-preview)
    project="${2:?Usage: ./dev deploy-preview <project>}"
    port="${PROJECT_PORTS[$project]}"
    dir="${PROJECT_DIRS[$project]}"
    cf_name="${PAGES_PROJECTS[$project]}"

    if [[ -z "$cf_name" ]]; then
        echo "No Cloudflare project mapping for: $project"
        exit 1
    fi

    echo "Building $project..."
    (cd "$REPO_ROOT/$dir" && trunk build index.html --release)

    echo "Deploying preview..."
    wrangler pages deploy "$REPO_ROOT/$dir/dist" \
        --project-name="$cf_name" \
        --branch=preview

    echo "Production ($cf_name) was NOT touched."
    ;;
```

### 2. Lock down production deploys in CI

In `.github/workflows/deploy.yml`, ensure production deploys only run on `main` after checks pass:

```yaml
deploy:
  needs: [fmt, clippy, test]  # must pass first
  if: github.ref == 'refs/heads/main'
  steps:
    - run: wrangler pages deploy dist/ --project-name=${{ matrix.project }} --branch=main
```

### 3. Add pre-push git hook (optional)

Run `cargo fmt --check && cargo clippy --workspace` before push so local catches match CI. This makes "if local passes, CI passes" reliable.

```bash
# .git/hooks/pre-push
cargo fmt --check --quiet && cargo clippy --workspace --quiet
```

## Cloudflare Preview Retention

Configure in Cloudflare dashboard: **Pages → Settings → Builds & Deployments**

- Default: keep all preview deployments forever
- Can set auto-delete after N days
- Manual deletion available per deployment
- No cost — unlimited previews on free tier

## Why Not Deploy Production Locally?

| Concern | Local → Production | Local → Preview, CI → Production |
|---------|-------------------|----------------------------------|
| Speed | Instant | Preview instant, prod after CI |
| Safety | Can ship broken code | CI gates production |
| Sharing | Only your browser | Anyone can open preview URL |
| Rollback | Manual | Cloudflare one-click rollback |
| Audit | None | Git history + CI logs |
